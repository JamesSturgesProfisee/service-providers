{
  "artifactVersion": "1.5.1.0",
  "scripts": [
    {
      "Configuration": {
        "scriptContent": "import { fetch } from \"Profisee\";\r\n\r\nconst ASSET_TYPE_ID_CODE_VALUE = \"00000000-0000-0000-0000-000000021001\";\r\nconst ASSET_TYPE_ID_CODE_SET   = \"00000000-0000-0000-0000-000000021002\";\r\n\r\nconst DOMAIN_TYPE_ID_CODELIST = \"00000000-0000-0000-0000-000000020001\";\r\n\r\nconst RELATION_TYPE_ID_CODEVALUE_IN_CODESET = \"00000000-0000-0000-0000-000000007041\";\r\n\r\nconst ATTRIBUTE_TYPE_ID_DESCRIPTION = \"00000000-0000-0000-0000-000000003114\";\r\nconst ATTRIBUTE_TYPE_NAME_SYSTEM = \"System\";\r\n\r\nconst ATTRIBUTE_TYPE_NAME_SOURCE = \"Source\";\r\nconst ATTRIBUTE_TYPE_NAME_VALUE_SET_ID = \"Value Set ID\"\r\n\r\nfunction utf8Bytes(str) {\r\n  const bytes = [];\r\n  for (let i = 0; i \u003c str.length; i++) {\r\n    let codePoint = str.charCodeAt(i);\r\n    if (codePoint \u003e= 0xD800 \u0026\u0026 codePoint \u003c= 0xDBFF \u0026\u0026 i + 1 \u003c str.length) {\r\n      const next = str.charCodeAt(i + 1);\r\n      if (next \u003e= 0xDC00 \u0026\u0026 next \u003c= 0xDFFF) {\r\n        codePoint = 0x10000 + ((codePoint - 0xD800) \u003c\u003c 10) + (next - 0xDC00);\r\n        i++;\r\n      }\r\n    }\r\n    if (codePoint \u003c= 0x7F) {\r\n      bytes.push(codePoint);\r\n    } else if (codePoint \u003c= 0x7FF) {\r\n      bytes.push(0xC0 | (codePoint \u003e\u003e 6));\r\n      bytes.push(0x80 | (codePoint \u0026 0x3F));\r\n    } else if (codePoint \u003c= 0xFFFF) {\r\n      bytes.push(0xE0 | (codePoint \u003e\u003e 12));\r\n      bytes.push(0x80 | ((codePoint \u003e\u003e 6) \u0026 0x3F));\r\n      bytes.push(0x80 | (codePoint \u0026 0x3F));\r\n    } else {\r\n      bytes.push(0xF0 | (codePoint \u003e\u003e 18));\r\n      bytes.push(0x80 | ((codePoint \u003e\u003e 12) \u0026 0x3F));\r\n      bytes.push(0x80 | ((codePoint \u003e\u003e 6) \u0026 0x3F));\r\n      bytes.push(0x80 | (codePoint \u0026 0x3F));\r\n    }\r\n  }\r\n  return bytes;\r\n}\r\n\r\nfunction base64FromBytes(bytes) {\r\n  const chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\r\n  let out = \"\";\r\n  for (let i = 0; i \u003c bytes.length; i += 3) {\r\n    const b1 = bytes[i];\r\n    const b2 = i + 1 \u003c bytes.length ? bytes[i + 1] : 0;\r\n    const b3 = i + 2 \u003c bytes.length ? bytes[i + 2] : 0;\r\n    const triplet = (b1 \u003c\u003c 16) | (b2 \u003c\u003c 8) | b3;\r\n    const c1 = (triplet \u003e\u003e 18) \u0026 0x3F;\r\n    const c2 = (triplet \u003e\u003e 12) \u0026 0x3F;\r\n    const c3 = (triplet \u003e\u003e 6) \u0026 0x3F;\r\n    const c4 = triplet \u0026 0x3F;\r\n    out += chars.charAt(c1);\r\n    out += chars.charAt(c2);\r\n    out += (i + 1 \u003c bytes.length) ? chars.charAt(c3) : \"=\";\r\n    out += (i + 2 \u003c bytes.length) ? chars.charAt(c4) : \"=\";\r\n  }\r\n  return out;\r\n}\r\n\r\nfunction b64EncodeUtf8(str) {\r\n  return base64FromBytes(utf8Bytes(str));\r\n}\r\n\r\nfunction normalizeBaseUrl(baseUrl) {\r\n  if (!baseUrl) return \"\";\r\n  return baseUrl.endsWith(\"/\") ? baseUrl.slice(0, -1) : baseUrl;\r\n}\r\n\r\nfunction parseJsonSafe(body) {\r\n  if (!body) return null;\r\n  try { return JSON.parse(body); } catch { return { raw: body }; }\r\n}\r\n\r\nfunction httpJson(baseUrl, authHeader, method, path, bodyObj) {\r\n  const url = `${baseUrl}${path}`;\r\n  const options = {\r\n    method,\r\n    headers: {\r\n      \"Authorization\": authHeader,\r\n      \"Accept\": \"application/json\",\r\n      \"Content-Type\": \"application/json\"\r\n    }\r\n  };\r\n  if (bodyObj !== undefined \u0026\u0026 bodyObj !== null) {\r\n    options.body = JSON.stringify(bodyObj);\r\n  }\r\n\r\n  const res = fetch(url, options);\r\n\r\n  // Network exception (Connect fetch captures exceptions on the response object)\r\n  if (res.exceptionType) {\r\n    return {\r\n      ok: false,\r\n      status: res.status || 0,\r\n      error: res.error || `Request failed calling ${method} ${path}`,\r\n      body: res.body || \"\",\r\n      json: null\r\n    };\r\n  }\r\n\r\n  const json = parseJsonSafe(res.body);\r\n  if (!res.ok) {\r\n    return {\r\n      ok: false,\r\n      status: res.status,\r\n      error: `HTTP ${res.status} calling ${method} ${path}: ${res.body}`,\r\n      body: res.body || \"\",\r\n      json\r\n    };\r\n  }\r\n\r\n  return { ok: true, status: res.status, error: \"\", body: res.body || \"\", json };\r\n}\r\n\r\nfunction findFirstId(resultsContainer) {\r\n  return resultsContainer \u0026\u0026 resultsContainer.results \u0026\u0026 resultsContainer.results.length \u003e 0\r\n    ? resultsContainer.results[0].id\r\n    : null;\r\n}\r\n\r\nfunction getCommunityId(baseUrl, authHeader, communityName) {\r\n  const r = httpJson(baseUrl, authHeader, \"GET\",\r\n    `/rest/2.0/communities?name=${encodeURIComponent(communityName)}\u0026nameMatchMode=EXACT`);\r\n  if (!r.ok) throw new Error(r.error);\r\n  return findFirstId(r.json);\r\n}\r\n\r\nfunction getDomainId(baseUrl, authHeader, communityId, domainName) {\r\n  const r = httpJson(baseUrl, authHeader, \"GET\",\r\n    `/rest/2.0/domains?communityId=${encodeURIComponent(communityId)}\u0026name=${encodeURIComponent(domainName)}\u0026nameMatchMode=EXACT`);\r\n  if (!r.ok) throw new Error(r.error);\r\n  return findFirstId(r.json);\r\n}\r\n\r\nfunction createDomain(baseUrl, authHeader, communityId, domainName) {\r\n  const r = httpJson(\r\n    baseUrl,\r\n    authHeader,\r\n    \"POST\",\r\n    `/rest/2.0/domains`,\r\n    { name: domainName, typeId: DOMAIN_TYPE_ID_CODELIST, communityId }\r\n  );\r\n  if (!r.ok) throw new Error(r.error);\r\n  return r.json;\r\n}\r\n\r\nfunction findAssetIdInDomain(baseUrl, authHeader, domainId, assetName) {\r\n  const r = httpJson(baseUrl, authHeader, \"GET\",\r\n    `/rest/2.0/assets?domainId=${encodeURIComponent(domainId)}\u0026name=${encodeURIComponent(assetName)}\u0026nameMatchMode=EXACT`);\r\n  if (!r.ok) throw new Error(r.error);\r\n  return findFirstId(r.json);\r\n}\r\n\r\nfunction createAsset(baseUrl, authHeader, name, displayName, domainId, typeId) {\r\n  const r = httpJson(baseUrl, authHeader, \"POST\", `/rest/2.0/assets`, { name: name, displayName: displayName, typeId: typeId, domainId: domainId });\r\n  if (!r.ok) throw new Error(r.error);\r\n  return r.json;\r\n}\r\n\r\nfunction updateAsset(baseUrl, authHeader, assetId, fields) {\r\n  const r = httpJson(baseUrl, authHeader, \"PATCH\", `/rest/2.0/assets/${encodeURIComponent(assetId)}`, fields);\r\n  if (!r.ok) throw new Error(r.error);\r\n  return r.json;\r\n}\r\n\r\nfunction upsertCodeSetAsset(baseUrl, authHeader, domainId, codeSetName) {\r\n  const existingId = findAssetIdInDomain(baseUrl, authHeader, domainId, codeSetName);\r\n  if (existingId) {\r\n    return { id: existingId, created: false, updated: false };\r\n  }\r\n\r\n  const created = createAsset(baseUrl, authHeader, codeSetName, codeSetName, domainId, ASSET_TYPE_ID_CODE_SET);\r\n  const createdId = created \u0026\u0026 created.id ? created.id : \"\";\r\n  return { id: createdId, created: true, updated: false };\r\n}\r\nfunction upsertCodeValueAsset(baseUrl, authHeader, domainId, codeValueName, codeValueDisplayName) {\r\n  const existingId = findAssetIdInDomain(baseUrl, authHeader, domainId, codeValueName);\r\n  if (existingId) {\r\n    const patch = {};\r\n    if (codeValueName) patch.name = codeValueName;\r\n    if (codeValueDisplayName) patch.displayName = codeValueDisplayName;\r\n    if (Object.keys(patch).length \u003e 0) {\r\n      updateAsset(baseUrl, authHeader, existingId, patch);\r\n    }\r\n    return { id: existingId, created: false, updated: Object.keys(patch).length \u003e 0 };\r\n  }\r\n\r\n  const created = createAsset(baseUrl, authHeader, codeValueName, codeValueDisplayName, domainId, ASSET_TYPE_ID_CODE_VALUE);\r\n  const createdId = created \u0026\u0026 created.id ? created.id : \"\";\r\n  return { id: createdId, created: true, updated: false };\r\n}\r\n\r\nfunction findRelationId(baseUrl, authHeader, typeId, sourceId, targetId) {\r\n  const r = httpJson(\r\n    baseUrl,\r\n    authHeader,\r\n    \"GET\",\r\n    `/rest/2.0/relations?typeId=${encodeURIComponent(typeId)}\u0026sourceId=${encodeURIComponent(sourceId)}\u0026targetId=${encodeURIComponent(targetId)}`\r\n  );\r\n  if (!r.ok) throw new Error(r.error);\r\n  return findFirstId(r.json);\r\n}\r\n\r\nfunction createRelation(baseUrl, authHeader, typeId, sourceId, targetId) {\r\n  const r = httpJson(baseUrl, authHeader, \"POST\", `/rest/2.0/relations`, { typeId, sourceId, targetId });\r\n  if (!r.ok) throw new Error(r.error);\r\n  return r.json;\r\n}\r\n\r\nfunction findAttributeId(baseUrl, authHeader, assetId, attrTypeId) {\r\n  const r = httpJson(\r\n    baseUrl,\r\n    authHeader,\r\n    \"GET\",\r\n    `/rest/2.0/attributes?assetId=${encodeURIComponent(assetId)}\u0026typeIds=${encodeURIComponent(attrTypeId)}`\r\n  );\r\n  if (!r.ok) throw new Error(r.error);\r\n  return findFirstId(r.json);\r\n}\r\n\r\nfunction createAttribute(baseUrl, authHeader, assetId, typeId, value) {\r\n  const r = httpJson(baseUrl, authHeader, \"POST\", `/rest/2.0/attributes`, { assetId, typeId, value });\r\n  if (!r.ok) throw new Error(r.error);\r\n  return r.json;\r\n}\r\n\r\nfunction updateAttribute(baseUrl, authHeader, attributeId, value) {\r\n  const r = httpJson(baseUrl, authHeader, \"PATCH\", `/rest/2.0/attributes/${encodeURIComponent(attributeId)}`, { value });\r\n  if (!r.ok) throw new Error(r.error);\r\n  return r.json;\r\n}\r\n\r\nfunction upsertAttribute(baseUrl, authHeader, assetId, attrTypeId, value) {\r\n  if (!attrTypeId || value === undefined || value === null || value === \"\") return;\r\n  const attrId = findAttributeId(baseUrl, authHeader, assetId, attrTypeId);\r\n  if (attrId) {\r\n    updateAttribute(baseUrl, authHeader, attrId, value);\r\n  } else {\r\n    createAttribute(baseUrl, authHeader, assetId, attrTypeId, value);\r\n  }\r\n}\r\n\r\nfunction getAttributeTypeIdByName(baseUrl, authHeader, attributeTypeName) {\r\n  if (!attributeTypeName) return \"\";\r\n\r\n  const r = httpJson(\r\n    baseUrl,\r\n    authHeader,\r\n    \"GET\",\r\n    `/rest/2.0/attributeTypes/name/${encodeURIComponent(attributeTypeName)}`\r\n  );\r\n\r\n  if (!r.ok) throw new Error(r.error);\r\n\r\n  return r.json \u0026\u0026 r.json.id ? r.json.id : \"\";\r\n}\r\n\r\nexport function execute(input) {\r\n  try {\r\n    const records = (input \u0026\u0026 input.records) ? input.records : [];\r\n\r\n    if (!records || records.length === 0) {\r\n      throw(\"No records\");\r\n    }\r\n\r\n    const baseUrl = normalizeBaseUrl(input.baseUrl);\r\n    const username = input.username;\r\n    //workaround for bug in 25.4. When 26.1 is released, revert this back to:\r\n    // const password = input.password\r\n    const password = (input.password \u0026\u0026 input.password.configuration \u0026\u0026 input.password.configuration.value !== undefined)\r\n      ? input.password.configuration.value\r\n      : input.password;\r\n    const rawBasic = String(username) + \":\" + String(password);\r\n    const encodedBasic = b64EncodeUtf8(rawBasic);\r\n    const authHeader = \"Basic \" + encodedBasic;\r\n    let sourceAttrTypeId = \"\";\r\n    sourceAttrTypeId = getAttributeTypeIdByName(baseUrl, authHeader, ATTRIBUTE_TYPE_NAME_SOURCE);\r\n    if (!sourceAttrTypeId) throw(`Attribute type not found: ${ATTRIBUTE_TYPE_NAME_SOURCE}`);\r\n\r\n    let valueSetIdAttributeTypeId = \"\";\r\n    valueSetIdAttributeTypeId = getAttributeTypeIdByName(baseUrl, authHeader, ATTRIBUTE_TYPE_NAME_VALUE_SET_ID);\r\n    let systemAttrTypeId = \"\";\r\n    systemAttrTypeId = getAttributeTypeIdByName(baseUrl, authHeader, ATTRIBUTE_TYPE_NAME_SYSTEM);\r\n    if (!systemAttrTypeId) throw(`Attribute type not found: ${ATTRIBUTE_TYPE_NAME_SYSTEM}`);\r\n\r\n    const communityIds = {}; // communityName -\u003e communityId\r\n    const domainIds = {};    // `${communityId}::${domainName}` -\u003e domainId\r\n    const codeSetIds = {};   // `${domainId}::${codeSetName}` -\u003e codeSetId\r\n\r\n    const outputRecords = [];\r\n\r\n    for (let i = 0; i \u003c records.length; i++) {\r\n      const r = records[i] || {};\r\n      const codeValueName = r.codeValueName;\r\n      const codeValueDisplayName = r.codeValueDisplayName;\r\n      const description = r.description;\r\n      const system = r.system;\r\n      const communityName = r.communityName;\r\n      const domainName = r.domainName;\r\n      const codeSetName = r.codeSetName;\r\n      const source = r.source;\r\n      const valueSetIdAttributeValue = r.valueSetId;\r\n\r\n      try {\r\n        if (!communityName) throw(`communityName is required (row ${i})`);\r\n        if (!domainName) throw(`domainName is required (row ${i})`);\r\n        if (!codeSetName) throw(`codeSetName is required (row ${i})`);\r\n\r\n        let communityId = communityIds[communityName];\r\n        if (!communityId) {\r\n          communityId = getCommunityId(baseUrl, authHeader, communityName);\r\n          if (!communityId) throw(`Community not found: ${communityName}`);\r\n          communityIds[communityName] = communityId;\r\n        }\r\n\r\n        const domainKey = `${communityId}::${domainName}`;\r\n        let domainId = domainIds[domainKey];\r\n        if (!domainId) {\r\n          domainId = getDomainId(baseUrl, authHeader, communityId, domainName);\r\n          if (!domainId) {\r\n            const createdDomain = createDomain(baseUrl, authHeader, communityId, domainName);\r\n            domainId = createdDomain \u0026\u0026 createdDomain.id ? createdDomain.id : \"\";\r\n            if (!domainId) throw(`Failed to create Domain: ${domainName}`);\r\n          }\r\n          domainIds[domainKey] = domainId;\r\n        }\r\n\r\n        const codeSetKey = `${domainId}::${codeSetName}`;\r\n        let codeSetId = codeSetIds[codeSetKey];\r\n        if (!codeSetId) {\r\n          const codeSetUpsert = upsertCodeSetAsset(baseUrl, authHeader, domainId, codeSetName);\r\n          codeSetId = codeSetUpsert.id;\r\n          if (!codeSetId) throw(`Failed to upsert Code Set asset: ${codeSetName}`);\r\n          codeSetIds[codeSetKey] = codeSetId;\r\n        }\r\n\r\n        if (source) {\r\n          upsertAttribute(baseUrl, authHeader, codeSetId, sourceAttrTypeId, source);\r\n        }\r\n\r\n        if (valueSetIdAttributeValue) {\r\n          if (!valueSetIdAttributeTypeId) {\r\n            throw(`Attribute type not found: ${ATTRIBUTE_TYPE_NAME_VALUE_SET_ID}`);\r\n          }\r\n          upsertAttribute(baseUrl, authHeader, codeSetId, valueSetIdAttributeTypeId, valueSetIdAttributeValue);\r\n        }\r\n        if (!codeValueName) throw(`codeValueName is required (row ${i})`);\r\n\r\n        const codeValueUpsert = upsertCodeValueAsset(baseUrl, authHeader, domainId, codeValueName, codeValueDisplayName);\r\n        const codeValueId = codeValueUpsert.id;\r\n\r\n        if (!codeValueId) throw(\"Could not determine Code Value ID\");\r\n\r\n        // Relation: Code Value -\u003e Code Set\r\n        const relId = findRelationId(\r\n          baseUrl,\r\n          authHeader,\r\n          RELATION_TYPE_ID_CODEVALUE_IN_CODESET,\r\n          codeValueId,\r\n          codeSetId\r\n        );\r\n        if (!relId) {\r\n          createRelation(baseUrl, authHeader, RELATION_TYPE_ID_CODEVALUE_IN_CODESET, codeValueId, codeSetId);\r\n        }\r\n\r\n        if (description) {\r\n          upsertAttribute(baseUrl, authHeader, codeValueId, ATTRIBUTE_TYPE_ID_DESCRIPTION, description);\r\n        }\r\n\r\n        if (system) {\r\n          upsertAttribute(baseUrl, authHeader, codeValueId, systemAttrTypeId, system);\r\n        }\r\n\r\n        outputRecords.push({\r\n          codeValueName: codeValueName,\r\n          codeValueId: codeValueId,\r\n          codeUrl: `${baseUrl}/domain/${domainId}`,\r\n        });\r\n\r\n      } catch (e) {\r\n        const msg = e \u0026\u0026 e.message ? e.message : String(e);\r\n        throw(`Row ${i} Error: ${msg}`);\r\n      }\r\n    }\r\n    return { isSuccess: true, records: outputRecords };\r\n  } catch (e) {\r\n    const msg = e \u0026\u0026 e.message ? e.message : String(e);\r\n    return { isSuccess: false, error: `ERROR: ${msg}` }\r\n  }\r\n}\r\n"
      },
      "Id": "3e66f388-8579-4a5a-958b-c6e8a7c1e750",
      "Code": "3e66f388-8579-4a5a-958b-c6e8a7c1e750",
      "Name": "UpsertAssets"
    }
  ],
  "serviceProviderRecord": {
    "Configuration": {
      "workerQueueOptions": {
        "workerCount": 1,
        "priorityQueueThreshold": {
          "maxJobCount": 1,
          "maxRecordCount": 1000
        }
      },
      "services": {
        "UpsertAssets": {
          "name": "Upsert Assets",
          "description": "Upserts Domains, Code Sets, and Code Values to Collibra",
          "inputs": {
            "connection": {
              "scope": "Service",
              "friendlyName": "Connection Details",
              "presenterConfiguration": {
                "type": "ParameterSet",
                "settings": {
                  "Parameters": {
                    "Base URL": "baseUrl",
                    "Username": "username",
                    "Password": "password"
                  }
                }
              },
              "isRequired": false
            },
            "baseUrl": {
              "type": "String",
              "scope": "Service",
              "friendlyName": "Base URL",
              "presenterConfiguration": {
                "type": "String",
                "settings": {}
              },
              "isRequired": true,
              "isReadOnly": false
            },
            "username": {
              "type": "String",
              "scope": "Service",
              "friendlyName": "Username",
              "presenterConfiguration": {
                "type": "String",
                "settings": {}
              },
              "isRequired": true,
              "isReadOnly": false
            },
            "password": {
              "scope": "Service",
              "friendlyName": "Password",
              "presenterConfiguration": {
                "type": "Credential",
                "settings": {}
              },
              "isRequired": true,
              "isReadOnly": false
            },
            "communityName": {
              "type": "String",
              "scope": "Data",
              "friendlyName": "Community Name",
              "presenterConfiguration": {
                "type": "String",
                "settings": {}
              },
              "isRequired": true,
              "isReadOnly": false
            },
            "domainName": {
              "type": "String",
              "scope": "Data",
              "friendlyName": "Domain Name",
              "presenterConfiguration": {
                "type": "Expression",
                "settings": {}
              },
              "isRequired": true,
              "isReadOnly": false
            },
            "codeSetName": {
              "type": "String",
              "scope": "Data",
              "friendlyName": "Code Set Name",
              "presenterConfiguration": {
                "type": "Expression",
                "settings": {}
              },
              "isRequired": true,
              "isReadOnly": false
            },
            "valueSetId": {
              "scope": "Data",
              "type": "String",
              "friendlyName": "Value Set ID",
              "isRequired": true,
              "isReadOnly": false,
              "presenterConfiguration": {
                "type": "Expression",
                "settings": {}
              }
            },
            "source": {
              "scope": "Data",
              "type": "String",
              "friendlyName": "Source",
              "isRequired": true,
              "isReadOnly": false,
              "presenterConfiguration": {
                "type": "Expression",
                "settings": {}
              }
            },
            "codeValueName": {
              "type": "String",
              "scope": "Data",
              "friendlyName": "Code Value Name",
              "presenterConfiguration": {
                "type": "Expression",
                "settings": {}
              },
              "isRequired": true,
              "isReadOnly": false
            },
            "codeValueDisplayName": {
              "scope": "Data",
              "type": "String",
              "friendlyName": "Code Value Display Name",
              "isRequired": false,
              "presenterConfiguration": {
                "type": "Expression",
                "settings": {}
              }
            },
            "description": {
              "type": "String",
              "scope": "Data",
              "friendlyName": "Description",
              "presenterConfiguration": {
                "type": "Expression",
                "settings": {}
              },
              "isRequired": true,
              "isReadOnly": false
            },
            "system": {
              "scope": "Data",
              "type": "String",
              "friendlyName": "System",
              "isRequired": true,
              "isReadOnly": false,
              "presenterConfiguration": {
                "type": "Expression",
                "settings": {}
              }
            }
          },
          "outputs": {
            "codeValueName": {
              "name": "Name",
              "type": "String"
            },
            "codeValueId": {
              "name": "ID",
              "type": "String"
            },
            "codeUrl": {
              "name": "URL",
              "type": "String"
            }
          },
          "scriptId": "3e66f388-8579-4a5a-958b-c6e8a7c1e750",
          "maximumRecordsPerRequest": 100
        }
      }
    },
    "Id": "98d57a6a-2a41-4763-b0e7-b22b6c0899c6",
    "Code": "98d57a6a-2a41-4763-b0e7-b22b6c0899c6",
    "Name": "Collibra Service Provider",
    "Type": "Script"
  }
}